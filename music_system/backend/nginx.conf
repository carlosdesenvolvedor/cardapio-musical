user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # CORS Map
    map $http_origin $cors_origin {
        default "";
        "~^https?://(localhost|127\.0\.0\.1)(:[0-9]+)?$" "$http_origin";
        "https://music-system-421ee.web.app" "https://music-system-421ee.web.app";
        "https://music-system-421ee.web.app/" "https://music-system-421ee.web.app";
        "https://music-system-421ee.web.app:443" "https://music-system-421ee.web.app";
        "https://music-system-421ee.firebaseapp.com" "https://music-system-421ee.firebaseapp.com";
        "https://music-system-421ee.firebaseapp.com:443" "https://music-system-421ee.firebaseapp.com";
        "https://136.248.64.90.nip.io" "https://136.248.64.90.nip.io";
    }

    # Gzip
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;

    # Buffer & Timeout Settings
    client_body_buffer_size 10K;
    client_header_buffer_size 4k;
    client_max_body_size 500M;
    large_client_header_buffers 4 8k;

    # HTTP Redirect to HTTPS
    server {
        listen 80;
        server_name 136.248.64.90.nip.io _;
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # HTTPS Server
    server {
        listen 443 ssl default_server;
        server_name 136.248.64.90.nip.io _;

        ssl_certificate /etc/letsencrypt/live/136.248.64.90.nip.io/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/136.248.64.90.nip.io/privkey.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # Allow popups for Google Sign-In (GIS SDK)
        add_header Cross-Origin-Opener-Policy "same-origin-allow-popups" always;

        # API Block (Includes SignalR negotiation)
        location /api/ {
            set $cors_origin $http_origin;
            
            # Always add headers to both actual requests and preflights
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-signalr-user-agent,x-requested-with' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
            
            # Additional stability header
            add_header 'Cross-Origin-Opener-Policy' 'same-origin-allow-popups' always;

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' $cors_origin always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-signalr-user-agent,x-requested-with' always;
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            proxy_pass http://backend:8080;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port 443;

            # Prevent Upstream CORS leak
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';
            proxy_hide_header 'Access-Control-Allow-Credentials';
            # Keep Origin to allow backend CORS/Auth validation if needed
        }

        # SignalR WebSocket Hub
        location /chathub {
            proxy_pass http://backend:8080;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Credentials';
            proxy_set_header Origin "";
        }

        # Media - MinIO Proxy with Range Support
        location /media/ {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS, HEAD' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS, HEAD' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            # Forwarding to MinIO
            proxy_pass http://minio:9000;
            
            # Bucket Rewrites
            rewrite ^/media/music-system-media/(.*)$ /music-system-media/$1 break;
            rewrite ^/media/(.*)$ /music-system-media/$1 break;
            
            # Robust Proxy Settings
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # Streaming & Connection optimization
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Range Headers (Crucial for Video)
            proxy_set_header Range $http_range;
            proxy_set_header If-Range $http_if_range;

            # Clear Upstream CORS
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';
            proxy_hide_header 'Access-Control-Allow-Credentials';
            proxy_set_header Origin "";
        }

        # LiveKit
        location /livekit/ {
            proxy_pass http://livekit:7880/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        # Firebase Proxy
        location ~* /firebase/([^/]+)/(.*) {
            proxy_pass https://firebasestorage.googleapis.com/v0/b/$1/o/$2;
            proxy_set_header Host firebasestorage.googleapis.com;
            add_header 'Access-Control-Allow-Origin' '*' always;
        }
    }
}
